<!--
Aidan McLaughlin
11/17/2016
 -->

<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Creative Scene!</title>
    <style>
      html, body {
        margin: 0px;
      }

      h1 {
        margin: 20px;
      }

      canvas {
        display: block;
        margin: auto;
      }

    </style>
    <script src="https://cs.wellesley.edu/~cs307/threejs/libs/three-r80.min.js"></script>
    <script src="https://cs.wellesley.edu/~cs307/threejs/libs/OrbitControls.js"></script>
    <script src="https://cs.wellesley.edu/~cs307/threejs/libs/dat.gui.js"></script>
    <script src="https://cs.wellesley.edu/~cs307/threejs/libs/tw-fa16.js"></script>
  </head>
  <body>
    <script type="text/javascript" id="helpers">
      // Material Setup
      var roomMaterial = THREE.MeshPhongMaterial({color: 0xf7e0a2, shininess: 0});
      var lightMaterial = roomMaterial.clone();
      lightMaterial.side = THREE.FrontSide;
      var mattressMaterial = new THREE.MeshPhongMaterial({color: 0xf5e5c0});
      var frameMaterial = lightMaterial.clone();
      
      var redMaterial = new THREE.MeshPhongMaterial({color: 0xe06f4a});
      var blackMaterial = new THREE.MeshPhongMaterial({color: 0x666666});
      
      var tunerMaterial = new THREE.MeshPhongMaterial({color: 0xf7e0a2, shininess: 1});
      
      var tableTopMaterial = new THREE.MeshPhongMaterial({color: 0xe89e57});
      // var legMaterial = new THREE.MeshPhongMaterial({color: 0xf7e0a2});
      var legMaterial = roomMaterial.clone();
      
      var fridgeMaterial = mattressMaterial.clone();

      TW.loadTextures(
          ['cloth-normal-map.png'],
          function(textures) {
            mattressMaterial.normalMap = textures[0];
            mattressMaterial.normalScale.set(3,5);
            mattressMaterial.needsUpdate = true;
          });


      function createRoom(params) {
        var roomGeom = new THREE.BoxGeometry(params.roomWidth, params.roomHeight, params.roomLength);
        var room = new THREE.Mesh(roomGeom, roomMaterial);
        room.material.side = THREE.BackSide;
        room.position.setY(params.roomHeight/2);

        var topLight = new THREE.PointLight( 0xffffff, 0.6);
        topLight.position.setY(params.roomHeight/2 - 1);
        room.add(topLight);

        var ceilingLight = new THREE.Object3D();
        var lightCoverGeom = new THREE.CylinderGeometry(params.roomWidth/20,
                                                        params.roomWidth/20,
                                                        params.roomHeight/30,
                                                        20);
        var lightCover = new THREE.Mesh(lightCoverGeom, lightMaterial);
        var lightFrameGeom = new THREE.SphereGeometry(params.roomWidth/19, 20, 20);
        var lightFrame = new THREE.Mesh(lightFrameGeom, lightMaterial);
        lightCover.position.setY(-params.roomHeight/(2*30));
        lightFrame.scale.setY(0.1);
        ceilingLight.add(lightCover);
        ceilingLight.add(lightFrame);
        ceilingLight.position.setY(params.roomHeight/2);
        room.add(ceilingLight);

        return room;
      }

      function createBed(params) {
        var bed = new THREE.Object3D();

        // for readability
        var width = params.bedWidth;
        var height = params.bedHeight;
        var length = params.bedLength;

        var topMattress = new THREE.Mesh(
          new THREE.BoxGeometry( width, height, length),
          mattressMaterial);
        topMattress.position.setY(height * 2.5);
        bed.add(topMattress);
        
        var middleMattress = topMattress.clone();
        middleMattress.position.setY(height * 1.5);
        bed.add(middleMattress);

        var frame = new THREE.Mesh(
          new THREE.BoxGeometry( width, height, length),
          frameMaterial);
        frame.position.setY(height * 0.5);
        bed.add(frame);

        return bed;
      }

      function createRadio(params) {
        var radio = new THREE.Object3D();

        var bodyGeom = new THREE.BoxGeometry(params.radioWidth,
                                             params.radioHeight,
                                             params.radioLength);
        var body = new THREE.Mesh(bodyGeom, redMaterial);
        body.position.setY(params.radioHeight/2);
        radio.add(body);

        var antennaGeom = new THREE.CylinderGeometry(params.radioAntRadius,
                                                     params.radioAntRadius,
                                                     params.radioAntLength);
        var antenna = new THREE.Mesh(antennaGeom, redMaterial);
        antenna.position.setX(-params.radioWidth/8);
        antenna.position.setY(params.radioHeight + params.radioAntLength/3);
        antenna.rotation.x = Math.PI/8;
        antenna.rotation.y = Math.PI/8;
        antenna.rotation.z = -Math.PI/4;
        radio.add(antenna);

        var grill = new THREE.Object3D();
        var grillPieceVertGeom = new THREE.CylinderGeometry(params.radioWidth/60,
                                                        params.radioWidth/60,
                                                        params.radioHeight);
        var grillPieceVert = new THREE.Mesh(grillPieceVertGeom, blackMaterial);
        for (var i=0; i<params.radioWidth/2; i += params.radioWidth/25) {
          var temp = grillPieceVert.clone()
          temp.position.setX(i);
          grill.add(temp);
        }

        var grillPieceHorizGeom = new THREE.CylinderGeometry(params.radioWidth/60,
                                                        params.radioWidth/60,
                                                        params.radioWidth/2);
        var grillPieceHoriz = new THREE.Mesh(grillPieceHorizGeom, blackMaterial);
        grillPieceHoriz.rotation.z = -Math.PI/2;
        grillPieceHoriz.position.setX(params.radioWidth/4);
        for (var i=0; i<params.radioHeight; i += params.radioHeight/25) {
          var temp = grillPieceHoriz.clone()
          temp.position.setY(i - params.radioHeight/2);
          grill.add(temp);
        }
        grill.position.setX(-params.radioWidth/2);
        grill.position.setY(params.radioHeight/2);
        grill.position.setZ(params.radioLength/2);
        radio.add(grill);

        var tunerGeom = new THREE.BoxGeometry(params.radioWidth/3, params.radioHeight/6, 0.01);
        var tuner = new THREE.Mesh(tunerGeom, tunerMaterial);
        tuner.position.set(params.radioWidth/4,
                           3 * params.radioHeight/4,
                           params.radioLength/2);
        radio.add(tuner);

        var onButtonGeom = new THREE.CylinderGeometry(params.radioWidth/16, params.radioWidth/16, 0.05);
        var onButton = new THREE.Mesh(onButtonGeom, redMaterial);
        onButton.position.set(params.radioWidth/6,
                              params.radioHeight/2,
                              params.radioLength/2);
        onButton.rotation.x = Math.PI/2;
        radio.add(onButton);

        return radio;
      }

      function createTable(params) {
        var table = new THREE.Object3D();

        // Table top //
        var tableTop = new THREE.Object3D();
        var tableTopGeom = new THREE.BoxGeometry(params.tableWidth,
                                              params.tableThickness,
                                              params.tableLength);
        var tableTopWood = new THREE.Mesh(tableTopGeom, tableTopMaterial);
        tableTop.add(tableTopWood);

        // Radio on table top
        var radio = createRadio(params);
        radio.position.set(-params.tableWidth/4,
                           params.tableThickness/2,
                           params.tableLength/4);
        radio.rotation.y = 5 * Math.PI/8;
        tableTop.add(radio);

        tableTop.position.setY(params.tableHeight + params.tableThickness/2);
        table.add(tableTop);

        // Table legs
        var legGeom = new THREE.CylinderGeometry(params.tableLegRadius,
                                                 params.tableLegRadius,
                                                 params.tableHeight,
                                                 20);
        var leg = new THREE.Mesh(legGeom, legMaterial);
        var farLeftLeg = leg.clone();
        farLeftLeg.position.set(-params.tableWidth/2 + params.tableLegRadius,
                                params.tableHeight/2,
                                -params.tableLength/2 + params.tableLegRadius);
        var farRightLeg = leg.clone();
        farRightLeg.position.set(params.tableWidth/2 - params.tableLegRadius,
                                params.tableHeight/2,
                                -params.tableLength/2 + params.tableLegRadius);
        var nearRightLeg = leg.clone();
        nearRightLeg.position.set(params.tableWidth/2 - params.tableLegRadius,
                                params.tableHeight/2,
                                params.tableLength/2 - params.tableLegRadius);
        var nearLeftLeg = leg.clone();
        nearLeftLeg.position.set(-params.tableWidth/2 + params.tableLegRadius,
                                params.tableHeight/2,
                                params.tableLength/2 - params.tableLegRadius);

        table.add(farLeftLeg);
        table.add(farRightLeg);
        table.add(nearRightLeg);
        table.add(nearLeftLeg);

        return table;
      }

      function createFridge(params) {
        var fridge = new THREE.Object3D();

        var mainBoxGeom = new THREE.BoxGeometry(params.fridgeWidth,
                                                params.fridgeHeight,
                                                params.fridgeLength);
        var mainBox = new THREE.Mesh(mainBoxGeom, fridgeMaterial);
        mainBox.position.setY(params.fridgeHeight/2);
        fridge.add(mainBox);

        var topDoor = new THREE.Object3D();
        var topDoorWallGeom = new THREE.BoxGeometry(params.fridgeWidth,
                                                params.fridgeHeight/3.5, // 3.5 is arbitrary
                                                params.fridgeLength/4);  // same
        var topDoorWall = new THREE.Mesh(topDoorWallGeom, fridgeMaterial);
        topDoorWall.position.setY(params.fridgeHeight - params.fridgeHeight/(3.5*2));

        var topDoorHandleCurve =new THREE.CubicBezierCurve3(
          new THREE.Vector3(0, params.fridgeHeight/3.5 - 0.1, 0),
          new THREE.Vector3(0.1, 0.3, 0),
          new THREE.Vector3(0.25, 0.1, 0),
          new THREE.Vector3(0, 0.1, 0));
        var topDoorHandleGeom = new THREE.TubeGeometry( topDoorHandleCurve, 20, 0.025, 8, false );
        var topDoorHandle = new THREE.Mesh( topDoorHandleGeom, fridgeMaterial );
        topDoorHandle.position.set(-params.fridgeWidth/2 + 0.08,
                                    params.fridgeHeight - (params.fridgeHeight/3.5),
                                    0.05);
        topDoorHandle.rotation.y = -Math.PI/2;
        
        topDoor.add(topDoorWall);
        topDoor.add(topDoorHandle);
        topDoor.position.setZ(params.fridgeLength/2 + 0.125); // 0.125 is for a slight offset from the main box of the fridge
        
        fridge.add(topDoor);

        var bottomDoor = new THREE.Object3D();
        var bottomDoorWallGeom = new THREE.BoxGeometry(params.fridgeWidth,
                                                   params.fridgeHeight/1.5, // 1.5 is also arbitrary
                                                   params.fridgeLength/4);  // still same
        var bottomDoorWall = new THREE.Mesh(bottomDoorWallGeom, fridgeMaterial);
        bottomDoorWall.position.setY(params.fridgeHeight/(1.5*2));

        var bottomDoorHandleGeom = topDoorHandleGeom.clone();
        var bottomDoorHandle = new THREE.Mesh( bottomDoorHandleGeom, fridgeMaterial );
        bottomDoorHandle.position.set(-params.fridgeWidth/2 + 0.08,
                                    params.fridgeHeight/1.5,
                                    0.05);
        bottomDoorHandle.rotation.z = Math.PI;
        bottomDoorHandle.rotation.y = Math.PI/2;

        bottomDoor.add(bottomDoorWall);
        bottomDoor.add(bottomDoorHandle);
        bottomDoor.position.setZ(params.fridgeLength/2 + 0.125);

        fridge.add(bottomDoor);

        return fridge;
      }

      function createChair(params) {
        var chair = new THREE.Object3D();

        var chairSurfaceGeom = new THREE.BoxGeometry(params.chairWidth, params.chairWidth, params.chairHeight/20);
        var chairSurface = new THREE.Mesh(chairSurfaceGeom, redMaterial);

        var seat = chairSurface.clone()
        seat.position.setY(3 * params.chairHeight/8);
        seat.position.setZ(params.chairWidth/2);
        seat.rotation.x = Math.PI/2;

        var back = chairSurface.clone()
        back.position.setY(5 * params.chairHeight/8);

        var longLegGeom = new THREE.CylinderGeometry(params.chairWidth/20,
                                                     params.chairWidth/20,
                                                     2 * params.chairHeight/3);
        var longLeg = new THREE.Mesh(longLegGeom, redMaterial);
        longLeg.rotation.x = -3 * Math.PI/16;
        longLeg.position.setY(params.chairHeight/4);
        longLeg.position.setZ(params.chairWidth/2);

        var leftLongLeg = longLeg.clone();
        leftLongLeg.position.setX(-params.chairWidth/2 - params.chairWidth/20);
        var rightLongLeg = longLeg.clone();
        rightLongLeg.position.setX(params.chairWidth/2 + params.chairWidth/20);

        var smallLeg = longLeg.clone();
        smallLeg.scale.setY(3/4);
        smallLeg.position.setY(params.chairHeight/5);
        smallLeg.rotation.x = 3 * Math.PI/16;

        var leftShortLeg = smallLeg.clone();
        leftShortLeg.position.setX(-params.chairWidth/2 - params.chairWidth/20);

        var rightShortLeg = smallLeg.clone();
        rightShortLeg.position.setX(params.chairWidth/2 + params.chairWidth/20);

        chair.add(seat);
        chair.add(back);
        chair.add(leftLongLeg);
        chair.add(leftShortLeg);
        chair.add(rightLongLeg);
        chair.add(rightShortLeg);

        return chair;
      }

      function createScene(params, sceneNum) {
        var newScene = new THREE.Object3D();

        newScene.add(createRoom(params));

        var bed = createBed(params);
        bed.position.setX(params.roomWidth/2 - params.bedWidth/2);
        bed.position.setZ(-params.roomLength/2 + params.bedLength/2);
        newScene.add(bed);

        var table = createTable(params);
        table.position.setX(-params.roomWidth/2 + params.tableWidth/2 + 0.05);
        table.position.setZ(params.roomLength/2 - params.tableLength/2 - 0.25);
        newScene.add(table);

        var fridge = createFridge(params);
        fridge.position.setX(-params.roomWidth/2 + params.fridgeLength/2);
        fridge.position.setZ(-params.roomLength/2 + params.fridgeWidth/2 + 0.1);
        fridge.rotation.y = Math.PI / 2
        newScene.add(fridge);

        var chair = createChair(params);
        chair.rotation.y = -Math.PI/2;
        chair.position.set(-params.roomWidth/2 + params.tableWidth + params.chairWidth,
                         0,
                         params.roomLength/2 - params.tableLength/2 - params.chairWidth/2);
        newScene.add(chair);

        newScene.add(new THREE.AmbientLight(0xffffff, 0.2));

        return newScene;
      }
    </script>

    <script type="text/javascript" id="main">
      var canvas = createCanvas();
      var scenes = [],
          renderer,
          camera;
      
      function createCanvas() {
        var canvas = document.getElementById("canvas");
        if (canvas) {
          document.getElementById("canvas").remove();
        }
        canvas = document.createElement("canvas");
        canvas.id = "canvas",
        canvas.width = window.innerWidth - 5,
        canvas.height = window.innerHeight
        document.body.appendChild(canvas)
        return canvas;
      }

      function sceneSetup(params, sceneNum) {
        for (var i = 0.25; i<=256; i *= 4) {
          var scene = new THREE.Scene();
          var temp = createScene(params, sceneNum);
          sceneNum = (sceneNum + 1) % 2;
          temp.scale.set(i,i,i);
          temp.position.setZ( i * params.roomLength/2.1);
          temp.position.setY( i * -params.roomLength/2 );
          scene.add(temp);
          scenes.push(scene);
        }
        return scenes;
      }

      var Creative = function(params) {
        // Create the renderer
        renderer = new THREE.WebGLRenderer({
          canvas: canvas
        });
        renderer.setSize(canvas.clientWidth,canvas.clientHeight);
        renderer.setClearColor(0xffffff,1);

        camera = new THREE.PerspectiveCamera( 75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000 );
        camera.position.set(0, 0, 1.5 * 64);

        return {renderer: renderer, camera: camera}
      }
    </script>

    <script type="text/javascript" id="launch">

    /* params for the scene */
      var params = {
        roomWidth: 5,
        roomHeight: 3,
        roomLength: 3,
        
        bedWidth: 1.5,
        bedHeight: 0.2,
        bedLength: 2.5,
        
        tableWidth: 1.15,
        tableHeight: 0.9,
        tableLength: 1.5,
        tableThickness: 0.08,
        tableLegRadius: 0.03,

        radioWidth: 0.3,
        radioHeight: 0.2,
        radioLength: 0.05,
        radioAntLength: 0.25,
        radioAntRadius: 0.005,
        
        fridgeWidth: 1,
        fridgeHeight: 2.5,
        fridgeLength: 0.7,

        chairWidth: 0.5,
        chairHeight: 1.5,
      }

      function refreshScenes(params) {
        return new Promise(function (resolve, reject) {
          scenes = sceneSetup(params);
          resolve(true);
        });
      }
      
      var sceneNum = 0;
      function render() {
        camera.position.z += 0.5 + (new Date().getTime() - counter) * 0.0005;
        if (camera.position.z >= 1.5 * 256) {
          // sceneNum = (sceneNum + 1) % 2;
          // renderer.clear();
          refreshScenes(params).then(function(a) {console.log(a);});

          camera.position.z = 1.5 * 64;
          counter = new Date().getTime();
        }

        for (var i=0; i<scenes.length; i++) {
          renderer.render( scenes[i], camera );
        }
        requestAnimationFrame(render);
      }

      var counter;
      /* Set up the renderer */
      window.onload = function() {
        var model = new Creative(params);
        renderer.autoClear = false;
        counter = new Date().getTime();
        scenes = sceneSetup(params, sceneNum);
        render();
      }
    </script>
  </body>
</html>
